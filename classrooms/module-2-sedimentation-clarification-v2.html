<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Treatment Classroom ‚Äî Module 2: Sedimentation Basins (v2.0)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: #1a1a2e;
            color: #e8e8e8;
            overflow-x: hidden;
        }
        .header {
            background-color: #16213e;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #00ff88;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
            color: #00ff88;
        }
        .header .plant-info {
            color: #888888;
            font-size: 14px;
            margin-top: 5px;
        }
        .header .plant-info strong {
            color: #00ff88;
        }
        .main-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: auto 1fr;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 180px);
        }
        .controls-section {
            grid-column: 1 / 2;
            grid-row: 1 / 3;
            background-color: #16213e;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #00ff88;
            overflow-y: auto;
        }
        .overview-section {
            grid-column: 2 / 3;
            grid-row: 1 / 2;
            background-color: #16213e;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #00ff88;
        }
        .detail-section {
            grid-column: 2 / 3;
            grid-row: 2 / 3;
            background-color: #16213e;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #00ff88;
            position: relative;
        }
        .section-title {
            color: #00ff88;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #0f3460;
            padding-bottom: 10px;
        }
        .control-group {
            background-color: #0f3460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .control-label {
            color: #888888;
            font-size: 13px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        .control-value {
            font-family: 'Consolas', monospace;
            color: #00ff88;
            font-weight: bold;
        }
        input[type="range"] {
            width: 100%;
            height: 8px;
            background: #1a1a2e;
            outline: none;
            border-radius: 4px;
            margin-top: 5px;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #00ff88;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #00ff88;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }
        .basin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .basin-card {
            background-color: #0f3460;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #444;
            cursor: pointer;
            transition: all 0.3s;
        }
        .basin-card.selected {
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }
        .basin-card.offline {
            opacity: 0.5;
            border-color: #ff4444;
        }
        .basin-card:hover {
            transform: translateY(-2px);
        }
        .basin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .basin-name {
            font-size: 16px;
            font-weight: bold;
            color: #00ff88;
        }
        .basin-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-running {
            background-color: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        .status-offline {
            background-color: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
        .basin-metric {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 12px;
        }
        .metric-label {
            color: #888888;
        }
        .metric-value {
            font-family: 'Consolas', monospace;
            color: #e8e8e8;
        }
        .metric-value.good {
            color: #00ff88;
        }
        .metric-value.warning {
            color: #ffaa00;
        }
        .metric-value.danger {
            color: #ff4444;
        }
        .offline-button {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
        }
        .offline-button:hover {
            background-color: #cc0000;
        }
        .basin-card.offline .offline-button {
            background-color: #00ff88;
            color: #1a1a2e;
        }
        .basin-card.offline .offline-button:hover {
            background-color: #00cc6f;
        }
        .summary-box {
            background-color: #0f3460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #1a1a2e;
        }
        .summary-row:last-child {
            border-bottom: none;
        }
        .summary-label {
            color: #888888;
            font-size: 13px;
        }
        .summary-value {
            font-family: 'Consolas', monospace;
            font-weight: bold;
            color: #e8e8e8;
        }
        .alert-box {
            background-color: rgba(255, 170, 0, 0.1);
            border-left: 4px solid #ffaa00;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 12px;
        }
        .alert-box.danger {
            background-color: rgba(255, 68, 68, 0.1);
            border-color: #ff4444;
        }
        #visualization {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .footer {
            background-color: #16213e;
            padding: 15px 20px;
            border-top: 3px solid #00ff88;
            text-align: center;
            font-size: 13px;
            color: #888888;
            margin-top: 20px;
        }
        .instructions {
            background-color: rgba(0, 255, 136, 0.1);
            border-left: 4px solid #00ff88;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 12px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>MODULE 2: SEDIMENTATION BASINS</h1>
        <div class="plant-info">
            <strong>100 MGD Regional Water Treatment Plant</strong> | 4 Rectangular Basins: 200' √ó 50' √ó 14' deep
        </div>
    </div>

    <div class="main-container">
        <!-- CONTROLS SECTION -->
        <div class="controls-section">
            <div class="section-title">‚öôÔ∏è Plant Controls</div>

            <div class="instructions">
                <strong>Operator Instructions:</strong> Monitor all 4 basins. Take basins offline for maintenance - flow automatically redistributes to running basins. Watch surface overflow rate (SOR) - higher flow = less settling time = more carryover.
            </div>

            <div class="control-group">
                <div class="control-label">
                    <span>Total Plant Flow</span>
                    <span class="control-value"><span id="flowDisplay">100</span> MGD</span>
                </div>
                <input type="range" id="flowRate" min="60" max="130" value="100" step="2">
            </div>

            <div class="control-group">
                <div class="control-label">
                    <span>Water Temperature</span>
                    <span class="control-value"><span id="tempDisplay">15</span>¬∞C</span>
                </div>
                <input type="range" id="waterTemp" min="5" max="25" value="15" step="1">
            </div>

            <div class="control-group">
                <div class="control-label">
                    <span>Influent Turbidity (from coag)</span>
                    <span class="control-value"><span id="influentDisplay">8</span> NTU</span>
                </div>
                <input type="range" id="influentTurb" min="2" max="25" value="8" step="1">
            </div>

            <div class="summary-box">
                <div class="summary-row">
                    <span class="summary-label">Basins Online:</span>
                    <span class="summary-value" id="basinsOnline">4 of 4</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Flow per Basin:</span>
                    <span class="summary-value" id="flowPerBasin">25 MGD</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Average SOR:</span>
                    <span class="summary-value" id="avgSOR">1.4 gpm/ft¬≤</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Combined Effluent:</span>
                    <span class="summary-value" id="combinedEffluent">1.2 NTU</span>
                </div>
            </div>

            <div id="alertBox" class="alert-box" style="display: none;">
                <strong>‚ö†Ô∏è ALERT:</strong> <span id="alertText"></span>
            </div>

            <div class="section-title" style="margin-top: 25px;">Basin Status</div>

            <div class="basin-grid">
                <div class="basin-card selected" id="basinCard1" onclick="selectBasin(1)">
                    <div class="basin-header">
                        <span class="basin-name">BASIN #1</span>
                        <span class="basin-status status-running">RUNNING</span>
                    </div>
                    <div class="basin-metric">
                        <span class="metric-label">Flow:</span>
                        <span class="metric-value" id="flow1">25 MGD</span>
                    </div>
                    <div class="basin-metric">
                        <span class="metric-label">SOR:</span>
                        <span class="metric-value" id="sor1">1.4 gpm/ft¬≤</span>
                    </div>
                    <div class="basin-metric">
                        <span class="metric-label">Effluent:</span>
                        <span class="metric-value good" id="eff1">1.2 NTU</span>
                    </div>
                    <button class="offline-button" onclick="toggleBasin(1, event)">TAKE OFFLINE</button>
                </div>

                <div class="basin-card" id="basinCard2" onclick="selectBasin(2)">
                    <div class="basin-header">
                        <span class="basin-name">BASIN #2</span>
                        <span class="basin-status status-running">RUNNING</span>
                    </div>
                    <div class="basin-metric">
                        <span class="metric-label">Flow:</span>
                        <span class="metric-value" id="flow2">25 MGD</span>
                    </div>
                    <div class="basin-metric">
                        <span class="metric-label">SOR:</span>
                        <span class="metric-value" id="sor2">1.4 gpm/ft¬≤</span>
                    </div>
                    <div class="basin-metric">
                        <span class="metric-label">Effluent:</span>
                        <span class="metric-value good" id="eff2">1.2 NTU</span>
                    </div>
                    <button class="offline-button" onclick="toggleBasin(2, event)">TAKE OFFLINE</button>
                </div>

                <div class="basin-card" id="basinCard3" onclick="selectBasin(3)">
                    <div class="basin-header">
                        <span class="basin-name">BASIN #3</span>
                        <span class="basin-status status-running">RUNNING</span>
                    </div>
                    <div class="basin-metric">
                        <span class="metric-label">Flow:</span>
                        <span class="metric-value" id="flow3">25 MGD</span>
                    </div>
                    <div class="basin-metric">
                        <span class="metric-label">SOR:</span>
                        <span class="metric-value" id="sor3">1.4 gpm/ft¬≤</span>
                    </div>
                    <div class="basin-metric">
                        <span class="metric-label">Effluent:</span>
                        <span class="metric-value good" id="eff3">1.2 NTU</span>
                    </div>
                    <button class="offline-button" onclick="toggleBasin(3, event)">TAKE OFFLINE</button>
                </div>

                <div class="basin-card" id="basinCard4" onclick="selectBasin(4)">
                    <div class="basin-header">
                        <span class="basin-name">BASIN #4</span>
                        <span class="basin-status status-running">RUNNING</span>
                    </div>
                    <div class="basin-metric">
                        <span class="metric-label">Flow:</span>
                        <span class="metric-value" id="flow4">25 MGD</span>
                    </div>
                    <div class="basin-metric">
                        <span class="metric-label">SOR:</span>
                        <span class="metric-value" id="sor4">1.4 gpm/ft¬≤</span>
                    </div>
                    <div class="basin-metric">
                        <span class="metric-label">Effluent:</span>
                        <span class="metric-value good" id="eff4">1.2 NTU</span>
                    </div>
                    <button class="offline-button" onclick="toggleBasin(4, event)">TAKE OFFLINE</button>
                </div>
            </div>
        </div>

        <!-- OVERVIEW SECTION -->
        <div class="overview-section">
            <div class="section-title">üè≠ Plant Overview - Top View</div>
            <div style="text-align: center; padding: 20px;">
                <svg width="600" height="180" style="border: 2px solid #0f3460; border-radius: 8px; background: #0f3460;">
                    <!-- Basin 1 -->
                    <rect id="svgBasin1" x="10" y="40" width="135" height="100" fill="#2a5a7a" stroke="#00ff88" stroke-width="2" rx="5"/>
                    <text x="77.5" y="70" text-anchor="middle" fill="#e8e8e8" font-size="14" font-weight="bold">BASIN #1</text>
                    <text x="77.5" y="90" text-anchor="middle" fill="#00ff88" font-size="12" id="svgFlow1">25 MGD</text>
                    <text x="77.5" y="110" text-anchor="middle" fill="#888" font-size="11">200' √ó 50'</text>

                    <!-- Basin 2 -->
                    <rect id="svgBasin2" x="155" y="40" width="135" height="100" fill="#2a5a7a" stroke="#00ff88" stroke-width="2" rx="5"/>
                    <text x="222.5" y="70" text-anchor="middle" fill="#e8e8e8" font-size="14" font-weight="bold">BASIN #2</text>
                    <text x="222.5" y="90" text-anchor="middle" fill="#00ff88" font-size="12" id="svgFlow2">25 MGD</text>
                    <text x="222.5" y="110" text-anchor="middle" fill="#888" font-size="11">200' √ó 50'</text>

                    <!-- Basin 3 -->
                    <rect id="svgBasin3" x="300" y="40" width="135" height="100" fill="#2a5a7a" stroke="#00ff88" stroke-width="2" rx="5"/>
                    <text x="367.5" y="70" text-anchor="middle" fill="#e8e8e8" font-size="14" font-weight="bold">BASIN #3</text>
                    <text x="367.5" y="90" text-anchor="middle" fill="#00ff88" font-size="12" id="svgFlow3">25 MGD</text>
                    <text x="367.5" y="110" text-anchor="middle" fill="#888" font-size="11">200' √ó 50'</text>

                    <!-- Basin 4 -->
                    <rect id="svgBasin4" x="445" y="40" width="135" height="100" fill="#2a5a7a" stroke="#00ff88" stroke-width="2" rx="5"/>
                    <text x="512.5" y="70" text-anchor="middle" fill="#e8e8e8" font-size="14" font-weight="bold">BASIN #4</text>
                    <text x="512.5" y="90" text-anchor="middle" fill="#00ff88" font-size="12" id="svgFlow4">25 MGD</text>
                    <text x="512.5" y="110" text-anchor="middle" fill="#888" font-size="11">200' √ó 50'</text>

                    <!-- Flow arrow -->
                    <text x="300" y="25" text-anchor="middle" fill="#888" font-size="12">‚Üê RAW WATER FLOW ‚Üí</text>
                </svg>
                <div style="margin-top: 10px; font-size: 12px; color: #888;">
                    Click on a basin to view cross-section detail below
                </div>
            </div>
        </div>

        <!-- DETAIL SECTION -->
        <div class="detail-section">
            <div class="section-title">üìê Basin #<span id="selectedBasinNum">1</span> - Cross Section View</div>
            <div id="visualization"></div>
        </div>
    </div>

    <div class="footer">
        üí° <strong>Operator Tip:</strong> At 100 MGD with 4 basins, each basin handles 25 MGD (SOR ‚âà 1.4 gpm/ft¬≤). Taking a basin offline increases SOR to 1.9 gpm/ft¬≤ on remaining basins - watch for carryover increase. Cold water (viscosity) reduces settling - expect 10-15% lower removal in winter. Rule of thumb: Good settling needs SOR < 2.0 gpm/ft¬≤.
    </div>

    <script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODULE 2 V2.0: SEDIMENTATION - 100 MGD PLANT
// 4 BASINS, MULTI-UNIT OPERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const BASIN_SPECS = {
    length: 200, // feet
    width: 50, // feet
    depth: 14, // feet
    area: 10000 // sq ft (200 √ó 50)
};

let state = {
    flowRate: 100, // MGD total
    waterTemp: 15, // ¬∞C
    influentTurb: 8, // NTU
    basins: [
        { id: 1, online: true, selected: true },
        { id: 2, online: true, selected: false },
        { id: 3, online: true, selected: false },
        { id: 4, online: true, selected: false }
    ],
    selectedBasin: 1
};

function calculateViscosity(tempC) {
    const exponent = 247.8 / (tempC + 133.15);
    return 0.00002414 * Math.pow(10, exponent);
}

function calculateSettlingVelocity(tempC) {
    // Stokes' Law for typical floc particle (100 micron, density 1050 kg/m3)
    const g = 9.81;
    const rhoP = 1050;
    const rhoW = 1000;
    const d = 100e-6; // 100 microns
    const mu = calculateViscosity(tempC);
    const vs = (g * (rhoP - rhoW) * d * d) / (18 * mu);
    return vs * 3600; // m/hr
}

function updatePlant() {
    const basinsOnline = state.basins.filter(b => b.online).length;
    const flowPerBasin = basinsOnline > 0 ? state.flowRate / basinsOnline : 0;

    // Update summary
    document.getElementById('basinsOnline').textContent = `${basinsOnline} of 4`;
    document.getElementById('flowPerBasin').textContent = flowPerBasin.toFixed(1) + ' MGD';

    // Calculate SOR for running basins
    const sorPerBasin = (flowPerBasin * 694.44) / BASIN_SPECS.area; // gpm/ft¬≤
    document.getElementById('avgSOR').textContent = sorPerBasin.toFixed(2) + ' gpm/ft¬≤';

    // Calculate settling efficiency
    const vs = calculateSettlingVelocity(state.waterTemp); // m/hr
    const sorMetric = sorPerBasin * 1.47; // convert to m/hr
    const removalEff = Math.min(95, Math.max(50, 100 * (1 - sorMetric / vs)));

    // Calculate effluent turbidity
    const baseEffluent = state.influentTurb * (1 - removalEff / 100);
    const tempPenalty = (15 - state.waterTemp) * 0.02; // Cold water penalty
    const effluent = baseEffluent * (1 + tempPenalty);

    document.getElementById('combinedEffluent').textContent = effluent.toFixed(1) + ' NTU';

    // Update each basin
    state.basins.forEach((basin, idx) => {
        const basinNum = basin.id;
        const flow = basin.online ? flowPerBasin : 0;
        const sor = basin.online ? sorPerBasin : 0;
        const eff = basin.online ? effluent : 0;

        document.getElementById(`flow${basinNum}`).textContent = flow.toFixed(1) + ' MGD';
        document.getElementById(`sor${basinNum}`).textContent = sor.toFixed(2) + ' gpm/ft¬≤';
        document.getElementById(`eff${basinNum}`).textContent = eff.toFixed(1) + ' NTU';

        // Color code effluent
        const effElement = document.getElementById(`eff${basinNum}`);
        effElement.className = 'metric-value';
        if (eff < 2) effElement.classList.add('good');
        else if (eff < 4) effElement.classList.add('warning');
        else effElement.classList.add('danger');

        // Update SVG
        const svgBasin = document.getElementById(`svgBasin${basinNum}`);
        const svgFlow = document.getElementById(`svgFlow${basinNum}`);
        if (basin.online) {
            svgBasin.setAttribute('fill', '#2a5a7a');
            svgBasin.setAttribute('stroke', '#00ff88');
            svgFlow.textContent = flow.toFixed(1) + ' MGD';
        } else {
            svgBasin.setAttribute('fill', '#3a2020');
            svgBasin.setAttribute('stroke', '#ff4444');
            svgFlow.textContent = 'OFFLINE';
        }

        // Highlight selected basin in SVG
        if (basin.selected) {
            svgBasin.setAttribute('stroke-width', '4');
        } else {
            svgBasin.setAttribute('stroke-width', '2');
        }
    });

    // Alerts
    const alertBox = document.getElementById('alertBox');
    const alertText = document.getElementById('alertText');

    if (basinsOnline === 0) {
        alertBox.style.display = 'block';
        alertBox.className = 'alert-box danger';
        alertText.textContent = 'ALL BASINS OFFLINE - No treatment capacity!';
    } else if (basinsOnline === 1) {
        alertBox.style.display = 'block';
        alertBox.className = 'alert-box danger';
        alertText.textContent = 'Only 1 basin online - High SOR, expect carryover!';
    } else if (sorPerBasin > 2.0) {
        alertBox.style.display = 'block';
        alertBox.className = 'alert-box';
        alertText.textContent = 'SOR exceeds 2.0 gpm/ft¬≤ - Reduce flow or bring basin online';
    } else if (effluent > 3) {
        alertBox.style.display = 'block';
        alertBox.className = 'alert-box';
        alertText.textContent = 'High effluent turbidity - Check upstream coagulation';
    } else {
        alertBox.style.display = 'none';
    }
}

function toggleBasin(basinNum, event) {
    event.stopPropagation();
    const basin = state.basins[basinNum - 1];
    basin.online = !basin.online;

    const card = document.getElementById(`basinCard${basinNum}`);
    const button = card.querySelector('.offline-button');
    const status = card.querySelector('.basin-status');

    if (basin.online) {
        card.classList.remove('offline');
        button.textContent = 'TAKE OFFLINE';
        status.textContent = 'RUNNING';
        status.className = 'basin-status status-running';
    } else {
        card.classList.add('offline');
        button.textContent = 'BRING ONLINE';
        status.textContent = 'OFFLINE';
        status.className = 'basin-status status-offline';
    }

    updatePlant();
}

function selectBasin(basinNum) {
    state.basins.forEach(b => b.selected = false);
    state.basins[basinNum - 1].selected = true;
    state.selectedBasin = basinNum;

    for (let i = 1; i <= 4; i++) {
        document.getElementById(`basinCard${i}`).classList.remove('selected');
    }
    document.getElementById(`basinCard${basinNum}`).classList.add('selected');

    document.getElementById('selectedBasinNum').textContent = basinNum;

    updatePlant();
}

// P5.js visualization
let sketch = function(p) {
    let particles = [];

    p.setup = function() {
        const container = document.getElementById('visualization');
        const canvas = p.createCanvas(container.offsetWidth, container.offsetHeight);
        canvas.parent('visualization');
    };

    p.draw = function() {
        p.background(26, 26, 46);

        const selectedBasin = state.basins.find(b => b.selected);
        const isOnline = selectedBasin.online;

        // Basin dimensions (scaled)
        const basinLeft = 50;
        const basinRight = p.width - 50;
        const basinTop = 80;
        const basinBottom = p.height - 50;
        const basinWidth = basinRight - basinLeft;
        const basinHeight = basinBottom - basinTop;

        // Draw basin outline
        p.stroke(0, 255, 136);
        p.strokeWeight(3);
        p.noFill();
        p.rect(basinLeft, basinTop, basinWidth, basinHeight);

        // Labels
        p.fill(232, 232, 232);
        p.noStroke();
        p.textSize(12);
        p.textAlign(p.LEFT);
        p.text('INLET ‚Üí', basinLeft - 45, basinTop + 20);
        p.textAlign(p.RIGHT);
        p.text('‚Üê WEIR', basinRight + 45, basinTop + 20);
        p.textAlign(p.CENTER);
        p.text('200 feet', basinLeft + basinWidth/2, basinTop - 10);
        p.text('Sludge Blanket', basinLeft + basinWidth/2, basinBottom - 10);

        if (!isOnline) {
            p.fill(255, 68, 68);
            p.textSize(24);
            p.text('BASIN OFFLINE', p.width/2, p.height/2);
            return;
        }

        // Draw sludge layer
        const sludgeHeight = 30;
        p.fill(100, 80, 60);
        p.noStroke();
        p.rect(basinLeft, basinBottom - sludgeHeight, basinWidth, sludgeHeight);

        // Spawn particles
        if (p.frameCount % 5 === 0) {
            particles.push({
                x: basinLeft + 10,
                y: p.random(basinTop + 10, basinTop + basinHeight * 0.3),
                settled: false
            });
        }

        // Calculate velocities
        const basinsOnline = state.basins.filter(b => b.online).length;
        const flowPerBasin = state.flowRate / basinsOnline;
        const detentionTime = (BASIN_SPECS.area * BASIN_SPECS.depth * 7.48) / (flowPerBasin * 1e6 / 1440); // minutes
        const horizontalVel = basinWidth / (detentionTime * 60); // pixels per frame (60 fps)

        const vs = calculateSettlingVelocity(state.waterTemp);
        const settleVel = (vs / 3600) * (basinHeight / BASIN_SPECS.depth / 0.3048) / 60; // pixels per frame

        // Update and draw particles
        for (let i = particles.length - 1; i >= 0; i--) {
            const part = particles[i];

            if (!part.settled) {
                part.x += horizontalVel;
                part.y += settleVel;

                // Check if settled
                if (part.y >= basinBottom - sludgeHeight) {
                    part.settled = true;
                    part.color = p.color(0, 255, 136); // Green - removed
                }

                // Check if carried over
                if (part.x >= basinRight) {
                    particles.splice(i, 1);
                    continue;
                }

                // Draw particle
                if (part.settled) {
                    p.fill(0, 255, 136);
                } else {
                    p.fill(200, 150, 100);
                }
                p.noStroke();
                p.circle(part.x, part.y, 4);

                // Draw settling trajectory
                p.stroke(200, 150, 100, 100);
                p.strokeWeight(1);
                p.line(part.x, part.y, part.x - 15, part.y - 15);
            }
        }

        // Limit particle count
        if (particles.length > 200) {
            particles = particles.slice(-200);
        }

        // Performance info
        const basinsOnlineCount = state.basins.filter(b => b.online).length;
        const sorPerBasin = (flowPerBasin * 694.44) / BASIN_SPECS.area;
        const settled = particles.filter(p => p.settled).length;
        const total = particles.length;
        const removalPct = total > 0 ? (settled / total * 100).toFixed(0) : 0;

        p.fill(232, 232, 232);
        p.noStroke();
        p.textSize(11);
        p.textAlign(p.LEFT);
        p.text(`Flow: ${flowPerBasin.toFixed(1)} MGD  |  SOR: ${sorPerBasin.toFixed(2)} gpm/ft¬≤  |  Removal: ${removalPct}%`, 20, 30);
        p.text('Green particles = Settled (removed)  |  Brown particles = Suspended (will carry over if reach weir)', 20, 50);
    };

    p.windowResized = function() {
        const container = document.getElementById('visualization');
        p.resizeCanvas(container.offsetWidth, container.offsetHeight);
    };
};

new p5(sketch);

// Event listeners
document.getElementById('flowRate').addEventListener('input', (e) => {
    state.flowRate = parseInt(e.target.value);
    document.getElementById('flowDisplay').textContent = state.flowRate;
    updatePlant();
});

document.getElementById('waterTemp').addEventListener('input', (e) => {
    state.waterTemp = parseInt(e.target.value);
    document.getElementById('tempDisplay').textContent = state.waterTemp;
    updatePlant();
});

document.getElementById('influentTurb').addEventListener('input', (e) => {
    state.influentTurb = parseInt(e.target.value);
    document.getElementById('influentDisplay').textContent = state.influentTurb;
    updatePlant();
});

// Initialize
updatePlant();
    </script>
</body>
</html>
